#!/usr/bin/env python

import sys
import argparse
from os import path
from ConfigParser import RawConfigParser


ARG_PARSER = argparse.ArgumentParser()
ARG_PARSER.add_argument('-n', '--dry-run', action='store_true', dest='dry',
                        help="Don't change the file.")
ARG_PARSER.add_argument('-f', '--file', type=str, metavar='MRCONFIG',
                        default='.mrconfig', help='The .mrconfig file.')


def main():
    args = ARG_PARSER.parse_args()
    filename = args.file
    directory = path.dirname(filename)

    # Read the configuration
    config = RawConfigParser()
    if filename not in config.read(filename):
        print "Could not read '%s'" % filename
        sys.exit(1)

    # Remove unused sections
    for section in config.sections()[:]:
        if not path.isdir(path.join(directory, section)):
            print "Removing '%s'. Directory no longer exists." % section
            config.remove_section(section)

    # Write new configuration
    if not args.dry:
        with open(filename, 'wb') as configfile:
            config.write(configfile)


if __name__ == '__main__':
    main()
